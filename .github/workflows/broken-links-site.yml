name: Check for broken links on site

on:
  workflow_run:
    workflows: [Deploy to AWS]
    types: [completed]

jobs:
  check-links-on-site:
    # https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#running-a-workflow-based-on-the-conclusion-of-another-workflow
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    # available images: https://github.com/actions/runner-images#available-images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v4
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.127.0'
          extended: true
      - uses: actions/cache@v2
        with:
          path: /tmp/hugo_cache
          key: ${{ runner.os }}-hugomod-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-hugomod-
      # - name: Update _config.yml ⚙️
      #   uses: fjogeleit/yaml-update-action@main
      #   with:
      #     commitChange: false
      #     valueFile: "_config.yml"
      #     changes: |
      #       {
      #         "giscus.repo": "${{ github.repository }}",
      #         "baseurl": ""
      #       }
      - name: Install and Build 🔧
        run: |
          hugo --minify -e production
      # - name: Purge unused CSS 🧹
      #   run: |
      #     npm install -g purgecss
      #     purgecss -c purgecss.config.js
      - name: Link Checker 🔗
        uses: lycheeverse/lychee-action@v1.9.0
        with:
          fail: true
          # only check local links
          args: --offline --verbose --no-progress 'public/**/*.html'
